#!/bin/bash
# info: stop aws ses domain
#

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#


# Argument definition
domain=$1

# Includes
source $VESTA/func/main.sh
source $VESTA/conf/vesta.conf

# Additional argument formatting
format_domain
format_domain_idn

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '1' "$#" 'DOMAIN'

web=$(grep -F -H "DOMAIN='$domain'" $VESTA/plugin/awsses/conf/clients.conf)
if [ -z "$web" ]; then
    check_result $E_NOTEXISTS "Domain $1 not exist"
fi

user=$($BIN/v-search-domain-owner $domain)
if [ -z "$user" ]; then
    check_result $E_EXISTS "User of domain $1 not found"
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

sed -i "/DOMAIN='$domain' /d" $VESTA/plugin/awsses/conf/clients.conf

# Concatenating string
sed -i "/*@$domain$/d" /etc/exim/ses-senders.conf
str="*@$domain"


#----------------------------------------------------------#
#                       Vesta                              #
#----------------------------------------------------------#
# Restarting Mail server
$BIN/v-restart-mail $restart
check_result $? "Mail restart failed" >/dev/null

# Logging
log_history "Remove Rocket configuration"
log_event "$OK" "$ARGUMENTS"

exit

